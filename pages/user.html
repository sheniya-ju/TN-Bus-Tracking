<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Panel | TN Bus Tracker</title>
<link rel="stylesheet" href="../style.css">
<script type="module" src="../firebase.js" defer></script>
<style>
/* existing styles */
</style>
</head>
<body>
<div class="header">
  User Panel
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="container">
  <div class="route-section">
    <h3>Find Bus by Route</h3>
    <select id="routeSelect"><option value="">-- Select Route --</option></select>
    <select id="busSelect"><option value="">-- Select Bus --</option></select>
    <button id="showBus">Show Bus on Map</button>
  </div>

  <div id="map"></div>

  <div class="complaint-box">
    <h3>Raise a Complaint</h3>
    <select id="complaintBus"><option value="">-- Select Bus --</option></select>
    <input type="text" id="userName" placeholder="Your Name">
    <input type="email" id="userEmail" placeholder="Your Email">
    <textarea id="userMessage" placeholder="Enter your complaint"></textarea>
    <button id="submitComplaint">Submit Complaint</button>
  </div>
</div>

<script type="module">
import { db, ref, get, onValue, push, auth, signOut, onAuthStateChanged } from "../firebase.js";

let map, marker;
function initMap(){ map = new google.maps.Map(document.getElementById("map"), { center:{lat:11.1271,lng:78.6569}, zoom:7 }); }
const script = document.createElement('script');
script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyBWoaMvAmBX_Ha4Vi-4UDsQmm0WQ1Y9hek&callback=initMap`;
script.async=true; document.head.appendChild(script);

const routeSelect=document.getElementById("routeSelect");
const busSelect=document.getElementById("busSelect");
const complaintBus=document.getElementById("complaintBus");
const showBusBtn=document.getElementById("showBus");

window.logout=async()=>{ await signOut(auth); window.location.href='./login.html'; }

// Load available routes from assignedDrivers
onValue(ref(db, "assignedDrivers"), snapshot=>{
  const data=snapshot.val();
  routeSelect.innerHTML=`<option value="">-- Select Route --</option>`;
  if(data) Object.values(data).forEach(d=>{
    if(d.route){
      const opt=document.createElement("option");
      opt.value=d.route; opt.textContent=d.route; routeSelect.appendChild(opt);
    }
  });
});

// Load buses for selected route
routeSelect.addEventListener("change", async ()=>{
  const route=routeSelect.value;
  busSelect.innerHTML=`<option value="">-- Select Bus --</option>`;
  complaintBus.innerHTML=`<option value="">-- Select Bus --</option>`;
  if(!route) return;

  const snap=await get(ref(db,"assignedDrivers"));
  if(snap.exists()){
    Object.values(snap.val()).forEach(d=>{
      if(d.route===route){
        const opt=document.createElement("option");
        opt.value=d.busNo; opt.textContent=`Bus: ${d.busNo}`; busSelect.appendChild(opt);

        const copt=document.createElement("option");
        copt.value=d.busNo; copt.textContent=d.busNo; complaintBus.appendChild(copt);
      }
    });
  }
});

// Show bus on map
showBusBtn.addEventListener("click", ()=>{
  const busNo=busSelect.value; if(!busNo){ alert("Select a bus"); return; }

  onValue(ref(db,"driversLocation"), snapshot=>{
    const data=snapshot.val(); if(!data) return;
    const loc=Object.values(data).find(d=>d.busId===busNo);
    if(!loc){ alert("Bus location not found yet"); return; }
    const pos={lat: loc.lat, lng: loc.lng};
    if(!marker) marker=new google.maps.Marker({position:pos,map,title:`Bus ${busNo}`});
    else marker.setPosition(pos);
    map.setCenter(pos); map.setZoom(14);
  });
});

// Submit complaint
document.getElementById("submitComplaint").addEventListener("click", async ()=>{
  const userName=document.getElementById("userName").value.trim();
  const userEmail=document.getElementById("userEmail").value.trim();
  const busId=complaintBus.value;
  const message=document.getElementById("userMessage").value.trim();
  if(!userName||!userEmail||!busId||!message){ alert("Fill all fields"); return; }
  const complaintRef=push(ref(db,"complaints"));
  await set(complaintRef,{userName,userEmail,busId,message,timestamp:new Date().toISOString()});
  alert("Complaint submitted successfully!");
  document.getElementById("userName").value="";
  document.getElementById("userEmail").value="";
  document.getElementById("userMessage").value="";
  complaintBus.value="";
});

// Check auth
onAuthStateChanged(auth, user=>{ if(!user) window.location.href='./login.html'; });

</script>
</body>
</html>
