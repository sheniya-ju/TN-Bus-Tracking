<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Panel | TN Bus Tracker</title>
<link rel="stylesheet" href="../style.css">
<style>
html, body { height:100%; margin:0; font-family:Arial,sans-serif; background:#F5F5F0; color:#5D866C; }
.header { background:#5D866C; color:white; padding:15px; text-align:center; position:sticky; top:0; font-size:1.5rem; }
.logout-btn { position:absolute; top:10px; right:20px; background:#C2A68C; color:white; border:none; padding:6px 12px; border-radius:5px; cursor:pointer; }
.logout-btn:hover { background:#E6D8C3; color:#5D866C; }
.container { padding:20px; display:flex; flex-direction:column; gap:20px; }
.mapwrap { height:400px; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.bus-list { background:#E6D8C3; padding:15px; border-radius:12px; max-height:200px; overflow-y:auto; }
.bus-list p { margin:6px 0; }
.complaint-box { background:#E6D8C3; padding:15px; border-radius:12px; }
input, textarea, button { width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #C2A68C; box-sizing:border-box; }
button { background:#5D866C; color:#F5F5F0; font-weight:bold; border:none; cursor:pointer; transition:0.2s; }
button:hover { background:#C2A68C; color:#5D866C; }
</style>
</head>
<body>
<div class="header">
  User Panel
  <button class="logout-btn" id="btnLogout">Logout</button>
</div>

<div class="container">
  <div class="bus-list" id="busList">
    <h3>Assigned Buses</h3>
    <p>Loading buses...</p>
  </div>

  <div class="mapwrap" id="map"></div>

  <div class="complaint-box">
    <h3>Raise a Complaint</h3>
    <input type="text" id="userName" placeholder="Your Name">
    <input type="email" id="userEmail" placeholder="Your Email">
    <textarea id="userMessage" placeholder="Enter your complaint"></textarea>
    <button id="submitComplaint">Submit Complaint</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { db, ref, onValue, push, set, auth, signOut, onAuthStateChanged } from "../firebase.js";

const btnLogout = document.getElementById('btnLogout');
btnLogout.addEventListener('click', async ()=>{ await signOut(auth); window.location.href='./login.html'; });

onAuthStateChanged(auth, user => { if(!user) window.location.href='./login.html'; });

// Map
const map = L.map('map').setView([11.1271,78.6569],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
const busMarkers = {};

// Display assigned buses
const busList = document.getElementById('busList');
onValue(ref(db, "assignedDrivers"), snapshot => {
  busList.innerHTML = "<h3>Assigned Buses</h3>";
  const data = snapshot.val();
  if(!data){ busList.innerHTML += "<p>No buses assigned</p>"; return; }

  Object.values(data).forEach(bus=>{
    const busP = document.createElement("p");
    busP.textContent = `Bus: ${bus.busNo}, Route: ${bus.route}`;
    busList.appendChild(busP);
  });
});

// Show bus locations live
onValue(ref(db, "driversLocation"), snapshot => {
  const data = snapshot.val();
  if(!data) return;

  Object.values(data).forEach(bus=>{
    if(busMarkers[bus.busId]){
      busMarkers[bus.busId].setLatLng([bus.lat, bus.lng]);
    } else {
      const m = L.marker([bus.lat, bus.lng]).addTo(map).bindPopup(`Bus: ${bus.busId}<br>Route: ${bus.route}`);
      busMarkers[bus.busId] = m;
    }
  });
});

// Submit complaint
document.getElementById("submitComplaint").addEventListener("click", async ()=>{
  const name = document.getElementById("userName").value.trim();
  const email = document.getElementById("userEmail").value.trim();
  const message = document.getElementById("userMessage").value.trim();
  if(!name || !email || !message){ alert("Fill all fields"); return; }

  const complaintRef = push(ref(db,"complaints"));
  await set(complaintRef, { userName: name, userEmail: email, message, timestamp: new Date().toISOString() });

  alert("Complaint submitted successfully!");
  document.getElementById("userName").value = "";
  document.getElementById("userEmail").value = "";
  document.getElementById("userMessage").value = "";
});
</script>
</body>
</html>
