<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Panel | TN Bus Tracker</title>
<link rel="stylesheet" href="../style.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body { font-family: Arial, sans-serif; background:#F5F5F0; margin:0; padding:0; }
.header { display:flex; justify-content:space-between; align-items:center; background:#5D866C; color:white; padding:12px 20px; position:sticky; top:0; }
.header .logo { display:flex; align-items:center; gap:10px; font-size:1.3rem; font-weight:bold; }
.header .logo img { height:40px; border-radius:6px; }
.logout-btn { background:#C2A68C; color:white; border:none; padding:6px 12px; border-radius:5px; cursor:pointer; }
.logout-btn:hover { background:#E6D8C3; color:#5D866C; }
.container { padding:20px; display:flex; flex-direction:column; gap:30px; }
#map { height:400px; width:100%; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
.complaint-box { background:#E6D8C3; padding:15px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
input, textarea, button { width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #C2A68C; box-sizing:border-box; }
button { background:#5D866C; color:#F5F5F0; font-weight:bold; border:none; cursor:pointer; transition:0.2s; }
button:hover { background:#C2A68C; color:#5D866C; }
</style>
</head>
<body>
<div class="header">
  <div class="logo">
    <img src="../image.jpeg" alt="TN Bus Tracker Logo"> User Panel
  </div>
  <button class="logout-btn" id="btnLogout">Logout</button>
</div>

<div class="container">
  <div id="map"></div>

  <div class="complaint-box">
    <h3>Raise a Complaint</h3>
    <input type="text" id="userName" placeholder="Your Name">
    <input type="email" id="userEmail" placeholder="Your Email">
    <input type="text" id="busId" placeholder="Bus Number">
    <textarea id="userMessage" placeholder="Enter your complaint"></textarea>
    <button id="submitComplaint">Submit Complaint</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { db, ref, onValue, push, set, auth, signOut, onAuthStateChanged } from "./firebase.js";

let map = L.map('map').setView([11.1271,78.6569], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

const markers = {};

// Logout
document.getElementById('btnLogout').addEventListener('click', async () => {
  await signOut(auth);
  window.location.href = '../index.html';
});

// Auth check
onAuthStateChanged(auth, user => {
  if(!user) window.location.href='./login.html';
});

// Load buses and live locations
function loadBuses() {
  onValue(ref(db, 'assignedDrivers'), snapshot => {
    const data = snapshot.val();
    if(!data) return;

    Object.entries(data).forEach(([driverKey, busData]) => {
      const busNo = busData.busNo;
      const route = busData.route;

      // Listen to driver location
      onValue(ref(db, `driversLocation/${driverKey}`), locSnap => {
        const loc = locSnap.val();
        if(!loc) return;

        const latLng = [loc.lat, loc.lng];
        if(markers[busNo]) {
          markers[busNo].setLatLng(latLng);
        } else {
          markers[busNo] = L.marker(latLng).addTo(map)
            .bindPopup(`<b>Bus:</b> ${busNo}<br><b>Route:</b> ${route}`);
        }
      });
    });
  });
}
loadBuses();

// Submit complaint
document.getElementById('submitComplaint').addEventListener('click', async () => {
  const userName = document.getElementById('userName').value.trim();
  const userEmail = document.getElementById('userEmail').value.trim();
  const busId = document.getElementById('busId').value.trim();
  const message = document.getElementById('userMessage').value.trim();

  if(!userName || !userEmail || !busId || !message) { alert('Fill all fields'); return; }

  const complaintRef = push(ref(db, 'complaints'));
  await set(complaintRef, { userName, userEmail, busId, message, timestamp: new Date().toISOString() });

  alert('Complaint submitted successfully!');
  document.getElementById('userName').value = '';
  document.getElementById('userEmail').value = '';
  document.getElementById('busId').value = '';
  document.getElementById('userMessage').value = '';
});
</script>
</body>
</html>
