<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Driver Panel â€” TN Bus Tracker</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html, body { 
  height:100%; 
  margin:0; 
  font-family:"Poppins", sans-serif; 
  background:#F5F5F0; 
  color:#5D866C; 
}
.topbar { 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  padding:12px 20px; 
  background:#5D866C; 
  color:white; 
  font-size:1.2rem; 
  font-weight:bold; 
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  position: sticky;
  top:0;
  z-index:100;
}
.logo { 
  display:flex; 
  align-items:center; 
  gap:10px; 
}
.logo img { 
  height:40px; 
  border-radius:6px; 
  background:#F5F5F0; 
  padding:2px; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.logout { 
  background: #C2A68C; 
  color: white; 
  border: none; 
  padding: 4px 8px; 
  border-radius: 5px; 
  cursor: pointer; 
  transition: 0.3s; 
  font-size: 0.8rem; 
  position: absolute; 
  top: 10px;
  right: 10px;
  z-index: 200; 
  width: auto !important; 
  white-space: nowrap; 
}
.logout:hover { 
  background:#E6D8C3; 
  color:#5D866C; 
}
.layout { 
  display:flex; 
  gap:18px; 
  padding:20px; 
  flex:1; 
  min-height: calc(100vh - 68px); 
  box-sizing: border-box;
}
.panel { 
  flex: 0 0 320px; 
  background:#E6D8C3; 
  padding:16px; 
  border-radius:12px; 
  overflow-y:auto; 
  box-shadow:0 2px 8px rgba(0,0,0,0.1); 
  color:#5D866C; 
  height:auto;
  max-height: calc(100vh - 68px); 
}
.mapwrap { 
  flex:1; 
  border-radius:12px; 
  overflow:hidden; 
  position:relative; 
  box-shadow:0 2px 8px rgba(0,0,0,0.1); 
  min-height:400px; 
  display:flex;
}
#map {
  flex:1; 
  width:100%; 
  height:100%; 
  min-height:400px;
}
input, button { 
  padding:10px; 
  border-radius:8px; 
  border:1px solid #C2A68C; 
  background:#F5F5F0; 
  margin-bottom:10px; 
  width:100%; 
  box-sizing:border-box; 
}
button { 
  background:#5D866C; 
  color:white; 
  font-weight:bold; 
  border:none; 
  cursor:pointer; 
  transition:0.3s; 
}
button:hover { 
  background:#C2A68C; 
  color:#5D866C;
}
/* Complaint box */
.complaint-section {
  margin-top: 20px;
  background: #F5F5F0;
  border-radius: 8px;
  padding: 10px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.complaint-item {
  background: #fff;
  border-left: 4px solid #5D866C;
  margin-bottom: 8px;
  padding: 8px;
  border-radius: 6px;
  font-size: 0.9rem;
}
.complaint-item b {
  color: #5D866C;
}
@media (max-width:768px){
  .layout { flex-direction:column; }
  .panel { width:100%; max-height:none; margin-bottom:20px; }
  .mapwrap { min-height:300px; }
  #map { min-height:300px; }
}
</style>
</head>
<body>
<header class="topbar">
  <div class="logo">
    <img src="../image.jpeg" alt="TN Govt Transport Logo"/> Driver Dashboard
  </div>
  <button id="btnLogout" class="logout">Logout</button>
</header>

<div class="layout">
  <aside class="panel">
    <h3>Your Assigned Bus</h3>
    <p id="busInfo">Loading...</p>
    <button id="btnShare">Share Live Location</button>
    <p id="status"></p>

    <div class="complaint-section">
      <h4>Complaints for Your Bus</h4>
      <div id="complaintsList">No complaints yet.</div>
    </div>
  </aside>

  <section class="mapwrap">
    <div id="map"></div>
  </section>
</div>

<script src="../assets/leaflet.js"></script>
<script type="module">
import { db, ref, get, set, update, auth, onAuthStateChanged, keyFromEmail, signOut, onValue } from "./firebase.js";

let map = L.map('map').setView([11.1271, 78.6569], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

const busInfo = document.getElementById('busInfo');
const btnShare = document.getElementById('btnShare');
const status = document.getElementById('status');
const complaintsList = document.getElementById('complaintsList');

let marker = null;
let watchId = null;
let assignedBus = null;
let assignedRoute = null;

// Logout
document.getElementById('btnLogout').addEventListener('click', async () => {
  await signOut(auth);
  window.location.href = '../index.html';
});

// Auth check
onAuthStateChanged(auth, async user => {
  if(!user) return window.location.href = '../index.html';
  
  const emailKey = keyFromEmail(user.email);
  const snap = await get(ref(db, `assignedDrivers/${emailKey}`));
  if(!snap.exists()){
    busInfo.textContent = "No bus assigned yet.";
    return;
  }

  const busData = snap.val();
  assignedBus = busData.busNo;
  assignedRoute = busData.route;

  busInfo.innerHTML = `<b>Bus:</b> ${busData.busNo}<br><b>Route:</b> ${busData.route}<br><b>Duration:</b> ${busData.durationDays || 'Permanent'}`;

  // Listen for complaints related to this bus
  onValue(ref(db, 'complaints'), snapshot => {
    const data = snapshot.val();
    if(!data){
      complaintsList.innerHTML = "No complaints yet.";
      return;
    }

    const relevant = Object.values(data).filter(c => c.busId === assignedBus);
    if(relevant.length === 0){
      complaintsList.innerHTML = "No complaints yet.";
    } else {
      complaintsList.innerHTML = relevant.map(c => `
        <div class="complaint-item">
          <b>Bus ${c.busId}</b><br>${c.message}
        </div>
      `).join('');
    }
  });

  // Show previous location
  const locSnap = await get(ref(db, `driversLocation/${emailKey}`));
  if(locSnap.exists()){
    const loc = locSnap.val();
    marker = L.marker([loc.lat, loc.lng]).addTo(map)
      .bindPopup(`Bus: ${busData.busNo}<br>Route: ${busData.route}`);
    map.setView([loc.lat, loc.lng], 14);
  }

  // Share live location
  btnShare.addEventListener('click', () => {
    if (!navigator.geolocation) return status.textContent = "Geolocation not supported.";

    if(watchId) navigator.geolocation.clearWatch(watchId);
    btnShare.disabled = true;
    status.textContent = "Sharing live location...";

    watchId = navigator.geolocation.watchPosition(
      async pos => {
        const { latitude: lat, longitude: lng } = pos.coords;

        await set(ref(db, `driversLocation/${emailKey}`), { lat, lng, busId: busData.busNo, route: busData.route, time: new Date().toISOString() });
        await update(ref(db, `routes/${busData.route}/${busData.busNo}`), { latitude: lat, longitude: lng });

        if (marker) marker.setLatLng([lat, lng]);
        else marker = L.marker([lat, lng]).addTo(map).bindPopup(`Bus: ${busData.busNo}<br>Route: ${busData.route}`).openPopup();

        map.setView([lat, lng], 14);
        status.textContent = `Location updated at ${new Date().toLocaleTimeString()}`;
      },
      err => status.textContent = "Unable to get location: " + err.message,
      { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
    );
  });
});
</script>
</body>
</html>
