<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Driver Panel â€” TN Bus Tracker</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html, body { 
  height:100%; 
  margin:0; 
  font-family:"Poppins", sans-serif; 
  background:#F5F5F0; 
  color:#5D866C; 
}

/* Topbar styled like Admin Panel */
.topbar { 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  padding:12px 20px; 
  background:#5D866C; 
  color:white; 
  font-size:1.2rem; 
  font-weight:bold; 
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  position: sticky;
  top:0;
  z-index:100;
}

/* Logo on the left */
.logo { 
  display:flex; 
  align-items:center; 
  gap:10px; 
}
.logo img { 
  height:40px; 
  border-radius:6px; 
  background:#F5F5F0; 
  padding:2px; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Logout button small, top-right corner like Admin */
.logout { 
  background: #C2A68C; 
  color: white; 
  border: none; 
  padding: 4px 8px; 
  border-radius: 5px; 
  cursor: pointer; 
  transition: 0.3s; 
  font-size: 0.8rem; 
  position: absolute; 
  top: 10px;
  right: 10px;
  z-index: 200; 
  width: auto !important; 
  white-space: nowrap; 
}
.logout:hover { 
  background:#E6D8C3; 
  color:#5D866C; 
}

/* Layout */
.layout { 
  display:flex; 
  gap:18px; 
  padding:20px; 
  flex:1; 
  min-height: calc(100vh - 68px); 
  box-sizing: border-box;
}

/* Panel */
.panel { 
  flex: 0 0 320px; 
  background:#E6D8C3; 
  padding:16px; 
  border-radius:12px; 
  overflow-y:auto; 
  box-shadow:0 2px 8px rgba(0,0,0,0.1); 
  color:#5D866C; 
  height:auto;
  max-height: calc(100vh - 68px); 
}

/* Map */
.mapwrap { 
  flex:1; 
  border-radius:12px; 
  overflow:hidden; 
  position:relative; 
  box-shadow:0 2px 8px rgba(0,0,0,0.1); 
  min-height:400px; 
  display:flex;
}

/* Map full height */
#map {
  flex:1; 
  width:100%; 
  height:100%; 
  min-height:400px;
}

/* Inputs & buttons */
input, button { 
  padding:10px; 
  border-radius:8px; 
  border:1px solid #C2A68C; 
  background:#F5F5F0; 
  margin-bottom:10px; 
  width:100%; 
  box-sizing:border-box; 
}
button { 
  background:#5D866C; 
  color:white; 
  font-weight:bold; 
  border:none; 
  cursor:pointer; 
  transition:0.3s; 
}
button:hover { 
  background:#C2A68C; 
  color:#5D866C;
}

/* Responsive adjustments */
@media (max-width:768px){
  .layout { flex-direction:column; }
  .panel { width:100%; max-height:none; margin-bottom:20px; }
  .mapwrap { min-height:300px; }
  #map { min-height:300px; }
}
</style>
</head>
<body>
<header class="topbar">
  <div class="logo">
    <img src="../image.jpeg" alt="TN Govt Transport Logo"/> Driver Dashboard
  </div>
  <button id="btnLogout" class="logout">Logout</button>
</header>

<div class="layout">
  <aside class="panel">
    <h3>Your Assigned Bus</h3>
    <p id="busInfo">Loading...</p>
    <button id="btnShare">Share Live Location</button>
    <p id="status"></p>
  </aside>

  <section class="mapwrap">
    <div id="map"></div>
  </section>
</div>

<script src="../assets/leaflet.js"></script>
<script type="module">
import { db, ref, get, set, updateDriverLocation, auth, onAuthStateChanged, keyFromEmail, signOut, update } from "./firebase.js";

let map = L.map('map').setView([11.1271, 78.6569], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

const busInfo = document.getElementById('busInfo');
const btnShare = document.getElementById('btnShare');
const status = document.getElementById('status');
let marker = null;
let watchId = null; // single watchPosition

// Logout
document.getElementById('btnLogout').addEventListener('click', async () => {
  await signOut(auth);
  window.location.href = '../index.html';
});

// Auth check & load assignment
onAuthStateChanged(auth, async user => {
  if(!user) return window.location.href = '../index.html';
  
  const emailKey = keyFromEmail(user.email);

  // Fetch assigned bus
  const snap = await get(ref(db, `assignedDrivers/${emailKey}`));
  if(!snap.exists()){
    busInfo.textContent = "No bus assigned yet.";
    return;
  }

  const busData = snap.val();
  const now = Date.now();
  if(busData.expiry && busData.expiry < now){
    busInfo.textContent = "Assignment expired.";
    if(marker) map.removeLayer(marker); // remove marker
    return;
  }

  // Display bus info
  busInfo.innerHTML = `<b>Bus:</b> ${busData.busNo}<br><b>Route:</b> ${busData.route}<br><b>Duration:</b> ${busData.durationDays || 'Permanent'}`;

  // Show previous location if exists
  const locSnap = await get(ref(db, `driversLocation/${emailKey}`));
  if(locSnap.exists()){
    const loc = locSnap.val();
    marker = L.marker([loc.lat, loc.lng]).addTo(map)
      .bindPopup(`Bus: ${busData.busNo}<br>Route: ${busData.route}`);
    map.setView([loc.lat, loc.lng], 14);
  }

  btnShare.addEventListener('click', () => {
    if (!navigator.geolocation) {
      status.textContent = "Geolocation not supported.";
      return;
    }

    // prevent multiple watchers
    if(watchId) navigator.geolocation.clearWatch(watchId);

    btnShare.disabled = true;
    status.textContent = "Sharing live location...";

    watchId = navigator.geolocation.watchPosition(
      async (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        const data = {
          lat,
          lng,
          busId: busData.busNo,
          route: busData.route,
          time: new Date().toISOString()
        };

        const emailKey = keyFromEmail(auth.currentUser.email);
        await set(ref(db, `driversLocation/${emailKey}`), data);
        await update(ref(db, `routes/${busData.route}/${busData.busNo}`), {
          latitude: lat,
          longitude: lng
        });

        // Map marker
        if (marker) {
          marker.setLatLng([lat, lng]);
        } else {
          marker = L.marker([lat, lng]).addTo(map)
            .bindPopup(`Bus: ${busData.busNo}<br>Route: ${busData.route}`)
            .openPopup();
        }

        map.setView([lat, lng], 14);
        status.textContent = `Location updated at ${new Date().toLocaleTimeString()}`;
      },
      (err) => {
        status.textContent = "Unable to get location: " + err.message;
      },
      { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
    );
  });

});
</script>
</body>
</html>
