<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Admin Panel | TN Bus Tracker</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<!-- Local Leaflet CSS -->
<link rel="stylesheet" href="../assets/leaflet.css"/>
<style>
body { font-family:"Poppins", sans-serif; background:#F5F5F0; margin:0; padding:0; }
.topbar { display:flex; justify-content:space-between; align-items:center; padding:12px 20px; background:#5D866C; color:white; font-size:1.2rem; font-weight:bold; }
.logo { display:flex; align-items:center; gap:10px; }
.logo img { height:40px; border-radius:6px; background:#F5F5F0; padding:2px; }
.logout-btn { background:#C2A68C; color:white; border:none; padding:6px 12px; border-radius:5px; cursor:pointer; }
.logout-btn:hover { background:#E6D8C3; color:#5D866C; }
.container { padding:20px; display:flex; flex-direction:column; gap:25px; }
.assign-box, .assigned-box, .complaint-box { background:#E6D8C3; padding:15px; border-radius:12px; }
.assign-box input, .assign-box select, .assign-box button { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #C2A68C; }
.assign-box button { background:#5D866C; color:white; border:none; cursor:pointer; }
.assign-box button:hover { background:#C2A68C; }
.assigned-list, .complaint-list { max-height:200px; overflow-y:auto; margin-top:10px; }
.assigned-item, .complaint-item { padding:8px; border-bottom:1px solid #C2A68C; display:flex; justify-content:space-between; align-items:center; }
.resolve-btn { background:#5D866C; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; }
.resolve-btn:hover { background:#C2A68C; }
#map { height: 250px; margin-top:10px; border-radius:8px; }
</style>
</head>
<body>

<div class="topbar">
  <div class="logo">
    <img src="../image.jpeg" alt="TN Logo"> Admin Panel
  </div>
  <button class="logout-btn" id="btnLogout">Logout</button>
</div>

<div class="container">
  <div class="assign-box">
    <h3>Assign Driver to Bus</h3>
    <input type="text" id="driverEmail" placeholder="Driver Email">
    <input type="text" id="busNo" placeholder="Bus Number">
    <input type="text" id="route" placeholder="Route Name">
    <input type="number" id="duration" placeholder="Duration in days (leave empty for permanent)">
    <button id="assignBtn">Assign Driver</button>
    <p id="assignStatus"></p>
  </div>

  <div class="assigned-box">
    <h3>Assigned Buses</h3>
    <div class="assigned-list" id="assignedList">Loading...</div>
    <div id="map"></div>
  </div>

  <div class="complaint-box">
    <h3>User Complaints</h3>
    <div class="complaint-list" id="complaintList">Loading...</div>
  </div>
</div>

<!-- Local Leaflet JS -->
<script src="../assets/leaflet.js"></script>

<script type="module">
import { db, ref, get, assignDriver, auth, signOut, remove } from "./firebase.js";

// Leaflet check
if(typeof L==='undefined'){ 
  console.error("Leaflet not loaded"); 
  document.getElementById('assignedList').textContent="Map library not loaded. Reload page."; 
  throw new Error("Leaflet not loaded"); 
}

// Logout
document.getElementById('btnLogout').addEventListener('click', async ()=>{
  try{ await signOut(auth); } catch(e){ console.warn("signOut error",e); }
  window.location.href='../index.html';
});

// Assign Driver
document.getElementById('assignBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('driverEmail').value.trim();
  const busNo = document.getElementById('busNo').value.trim();
  const route = document.getElementById('route').value.trim();
  const duration = document.getElementById('duration').value.trim();
  const statusEl = document.getElementById('assignStatus');

  if(!email || !busNo || !route){
    statusEl.textContent="❌ Fill all fields!";
    statusEl.style.color="red";
    return;
  }

  const durationDays = duration? parseInt(duration,10) : 'permanent';
  try{
    await assignDriver(email,busNo,route,durationDays);
    statusEl.textContent=`✅ ${busNo} assigned successfully to ${email} for ${durationDays} day(s)`;
    statusEl.style.color="green";
    document.getElementById('driverEmail').value="";
    document.getElementById('busNo').value="";
    document.getElementById('route').value="";
    document.getElementById('duration').value="";
    await loadAssignedBuses();
  }catch(err){
    statusEl.textContent=`❌ Error: ${err.message||err}`;
    statusEl.style.color="red";
    console.error("assignDriver error:",err);
  }
});

// Map
let map=null; 
let markers=[];
async function ensureMap(){
  if(map) return;
  map = L.map('map').setView([11.1271,78.6569],7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);
}

// Load Assigned Buses
async function loadAssignedBuses(){
  const listEl=document.getElementById('assignedList');
  try{
    const snap = await get(ref(db,'assignedDrivers'));
    listEl.innerHTML='';
    if(!snap.exists()){ 
      listEl.textContent='No assignments yet.'; 
      if(map && markers.length){ markers.forEach(m=>map.removeLayer(m)); markers=[]; }
      return; 
    }
    const data=snap.val();
    await ensureMap();
    if(markers.length){ markers.forEach(m=>map.removeLayer(m)); markers=[]; }

    Object.entries(data).forEach(([key,value])=>{
      const assignedAt=value.assignedAt?new Date(value.assignedAt).toLocaleString():'N/A';
      const duration=value.durationDays||'permanent';
      const div=document.createElement('div');
      div.className='assigned-item';
      div.textContent=`Driver: ${key.replace(/_/g,'.')} | Bus: ${value.busNo} | Route: ${value.route} | Assigned at: ${assignedAt} | Duration: ${duration} day(s)`;
      listEl.appendChild(div);

      if(value.lat!=null && value.lng!=null){
        const m=L.marker([value.lat,value.lng]).addTo(map)
                 .bindPopup(`${value.busNo} | ${value.route}`);
        markers.push(m);
      }
    });

    if(markers.length){
      const group=L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.2));
    }
  }catch(err){
    console.error("loadAssignedBuses error:",err);
    listEl.textContent='Error loading assignments';
  }
}

// Load Complaints
async function loadComplaints(){
  const listEl=document.getElementById('complaintList');
  try{
    const snap = await get(ref(db,'complaints'));
    listEl.innerHTML='';
    if(!snap.exists()){ listEl.textContent='No complaints yet.'; return; }
    const data=snap.val();
    Object.entries(data).forEach(([key,c])=>{
      const div=document.createElement('div');
      div.className='complaint-item';
      div.innerHTML=`<span>Bus: ${c.busId||'-'} | Name: ${c.userName} | Email: ${c.userEmail} | Message: ${c.message}</span>`;
      const btn=document.createElement('button');
      btn.className='resolve-btn';
      btn.textContent='Resolve';
      btn.addEventListener('click', async ()=>{
        try{
          await remove(ref(db,'complaints/'+key));
          div.remove();
        }catch(err){ console.error("Resolve error:",err); }
      });
      div.appendChild(btn);
      listEl.appendChild(div);
    });
  }catch(err){
    console.error("loadComplaints error:",err);
    listEl.textContent='Error loading complaints';
  }
}

// Initial load
loadAssignedBuses();
loadComplaints();
setInterval(()=>{ loadAssignedBuses(); loadComplaints(); },30000);

</script>
</body>
</html>
